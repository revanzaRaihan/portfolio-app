name: ðŸš€ Deploy to VPS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    # Hanya deploy saat push ke main, bukan saat PR dibuat
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      # ----------------------------------------
      # Step 1: Checkout (untuk validasi file workflow)
      # ----------------------------------------
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------
      # Step 2: Deploy ke VPS via SSH
      # ----------------------------------------
      - name: ðŸš€ Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e

            echo "ðŸ“‚ Masuk direktori project..."
            cd ${{ secrets.VPS_PATH }}

            echo "ðŸ”§ Set git config..."
            git config --global --add safe.directory ${{ secrets.VPS_PATH }}
            git config core.fileMode false

            echo "âš™ï¸ Tulis ulang .env dari secret..."
            cat > .env << 'ENVEOF'
            ${{ secrets.APP_ENV_PRODUCTION }}
            ENVEOF

            echo "â¬‡ï¸ Pull latest code dari GitHub..."
            git fetch origin
            git reset --hard origin/main

            echo "ðŸ“¦ Install PHP dependencies..."
            COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader

            echo "ðŸŽ¨ Install Node dependencies..."
            npm ci --legacy-peer-deps

            echo "ðŸ—ºï¸ Generate wayfinder types..."
            php artisan wayfinder:generate --with-form

            echo "ðŸ—ï¸ Build frontend + SSR (Vite)..."
            npm run build:ssr

            echo "ðŸ—„ï¸ Jalankan migration..."
            php artisan migrate --force

            echo "ðŸ§¹ Clear cache lama..."
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            php artisan cache:clear

            echo "âš¡ Cache untuk production..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize

            echo "ðŸ” Set permissions..."
            chown -R www-data:www-data storage bootstrap/cache
            chmod -R 775 storage bootstrap/cache

            echo "ðŸ”„ Restart SSR server..."
            pm2 restart portfolio-ssr || pm2 start ${{ secrets.VPS_PATH }}/ecosystem.config.cjs

            echo "âœ… Deploy selesai!"